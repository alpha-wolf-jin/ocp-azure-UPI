# ocp-azure-UPI

## Azure environment details

```
Resource Group: openenv
Application: openenv
Application/Client/Service Principal ID: XXXXXXX
Password: XXXXXXXXXXXXXXXXXXX
Tenant ID: XXXXXXXXXXXXXXXXXXXXXXXX
Subscription ID: XXXXXXXXXXXXXXXXX
```

Using this preconfigured service principal for ARO cluster
```
Resource Group: XXXXXXXXXXXXXX
Client ID: XXXXXXXXXXXXXXXXX
Client Secret: XXXXXXXXXXXXXXXXXXX
```


## Prepare the commands and pull secret

The below commands werer installed.

- oc command
- openshift-install command 
  - `wget https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/openshift-install-linux.tar.gz`
- pull secet is stored in the /root/pull-secet.txt
- Create defautl dir for cluster installatin
  - `mkdir aro06 ; cd aro06`
- Set Git Credentail cache
  - `git config --global credential.helper 'cache --timeout 7200'`


Please refer to the below link for those tasks:
[OpenShift Pages](https://docs.openshift.com/container-platform/4.10/installing/installing_azure/installing-azure-user-infra.html)

## Test azure cli login

### Add the evironment variable to `~/.bashrc`

[root@localhost aro06]# az login --service-principal -u $CLIENT_ID -p $PASSWORD --tenant $TENANT

> Remove the big file from commit
```
...
remote: error: File openshift-install is 590.87 MB; this exceeds GitHub's file size limit of 100.00 MB
remote: error: GH001: Large files detected. You may want to try Git Large File Storage - https://git-lfs.github.com.
To https://github.com/alpha-wolf-jin/ocp-azure-UPI.git
 ! [remote rejected] main -> main (pre-receive hook declined)
error: failed to push some refs to 'https://github.com/alpha-wolf-jin/ocp-azure-UPI.git'

[root@localhost aro06]# git reset --soft HEAD~1

[root@localhost aro06]# git reset HEAD openshift-install
Unstaged changes after reset:
D	openshift-install

[root@localhost aro06]# git rm --cached openshift-install
rm 'openshift-install'

[root@localhost aro06]# git commit --amend
...
 1 file changed, 10 insertions(+), 2 deletions(-)

[root@localhost aro06]# git push -u origin main
```


## 01 Create public DNS zone from  azure portal


[Azure Portal](https://portal.azure.com)

### Click the resouce group `openenv-g96kt`
![Once Login Azure portal](images/azure-rg-01.png)

### Click `Create` to create the public DNS ZONE
![Create DNS ZONE](images/azure-dns-zone-01.png)


### Specify the RG and DOMAIN name
![Specify Domain](images/azure-dns-zone-02.png)


### New DOMAIN name
![Once Login Azure portal](images/azure-dns-zone-03.png)


### DOMAIN is empty
![Once Login Azure portal](images/azure-dns-zone-04.png)


### Update the name server on bastion

```
[root@localhost ~]# ping -c 1 ns1-07.azure-dns.com.
PING ns1-07.azure-dns.com (40.90.4.7) 56(84) bytes of data.

[root@localhost ~]# vi /etc/resolv.conf 
# Generated by NetworkManager
nameserver 40.90.4.7
nameserver 8.8.8.8

[root@localhost ~]# vi /etc/sysconfig/network-scripts/ifcfg-enp1s0
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
NAME=enp1s0
DEVICE=enp1s0
ONBOOT=yes
IPADDR=192.168.122.36
PREFIX=24
GATEWAY=192.168.122.1
DNS1=40.90.4.7
DNS2=8.8.8.8

[root@localhost ~]# dig  example.opentlc.com -t NS

; <<>> DiG 9.11.26-RedHat-9.11.26-6.el8 <<>> example.opentlc.com -t NS
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 39471
;; flags: qr aa rd; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;example.opentlc.com.		IN	NS

;; ANSWER SECTION:
example.opentlc.com.	172800	IN	NS	ns1-07.azure-dns.com.
example.opentlc.com.	172800	IN	NS	ns2-07.azure-dns.net.
example.opentlc.com.	172800	IN	NS	ns3-07.azure-dns.org.
example.opentlc.com.	172800	IN	NS	ns4-07.azure-dns.info.

;; Query time: 32 msec
;; SERVER: 40.90.4.7#53(40.90.4.7)
;; WHEN: Sat Apr 09 16:27:29 +08 2022
;; MSG SIZE  rcvd: 182
```

## 02 Create Configuration file

**Create OCP configation file**

```
[root@localhost aro06]# ../openshift-install create install-config
? SSH Public Key /root/.ssh/id_ed25519.pub
? Platform azure
? azure subscription id <Subscription ID>
? azure tenant id <Tenant ID>
? azure service principal client id <preconfigured service principal Client ID>
? azure service principal client secret [? for help] <preconfigured service principal Client Secret>
INFO Saving user credentials to "/root/.azure/osServicePrincipal.json" 
INFO Credentials loaded from file "/root/.azure/osServicePrincipal.json" 
? Region eastus
? Base Domain example.opentlc.com
? Cluster Name aro
? Pull Secret [? for help] 
INFO Install-Config created in: .
```

**Customize configation file**

You can customize the configuartion file. Below command can help to understand how to customize it.
`[root@localhost aro06]# ../openshift-install explain installconfig.platform`

I did not modify the fconfiguartion file.
```
[root@localhost aro06]# cat install-config.yaml
apiVersion: v1
baseDomain: example.opentlc.com
compute:
- architecture: amd64
  hyperthreading: Enabled
  name: worker
  platform: {}
  replicas: 3
controlPlane:
  architecture: amd64
  hyperthreading: Enabled
  name: master
  platform: {}
  replicas: 3
metadata:
  creationTimestamp: null
  name: aro
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineNetwork:
  - cidr: 10.0.0.0/16
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16
platform:
  azure:
    baseDomainResourceGroupName: openenv-g96kt
    cloudName: AzurePublicCloud
    outboundType: Loadbalancer
    region: eastus
publish: External
pullSecret: 
sshKey: |
  ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIONeWKSpAxbJrkkThCxUjlVe80jSz2y9hIpDLpx43AyY root@localhost.localdomain
```



**Set the env variable based on configuration file**



```
[root@localhost aro06]# yq -r .metadata.name install-config.yaml
aro

[root@localhost aro06]# export CLUSTER_NAME=aro

[root@localhost aro06]# yq -r .platform.azure.region install-config.yaml
eastus

[root@localhost aro06]# export AZURE_REGION=eastus

[root@localhost aro06]# yq -r .baseDomain install-config.yaml
example.opentlc.com

[root@localhost aro06]# export BASE_DOMAIN=example.opentlc.com

[root@localhost aro06]# yq -r .platform.azure.baseDomainResourceGroupName install-config.yaml
openenv-g96kt

[root@localhost aro06]# export BASE_DOMAIN_RESOURCE_GROUP=openenv-g96kt
```
**backup configuration file**

The original configuration file will be consumed druing creation manifest files.

`[root@localhost aro06]# cp install-config.yaml ~/backup/install-config.yaml-9-April`



## 03 Create manifest files

**Create OCP configation file**

```
[root@localhost aro06]# ../openshift-install create manifests
INFO Credentials loaded from file "/root/.azure/osServicePrincipal.json" 
INFO Consuming Install Config from target directory 
INFO Manifests created in: manifests and openshift 
[root@localhost aro06]# tree
.
├── images
│   ├── azure-dns-zone-01.png
│   ├── azure-dns-zone-02.png
│   ├── azure-dns-zone-03.png
│   ├── azure-dns-zone-04.png
│   ├── azure-portal-01.png
│   ├── azure-rg-01.png
│   └── test
├── manifests
│   ├── cloud-provider-config.yaml
│   ├── cluster-config.yaml
│   ├── cluster-dns-02-config.yml
│   ├── cluster-infrastructure-02-config.yml
│   ├── cluster-ingress-02-config.yml
│   ├── cluster-network-01-crd.yml
│   ├── cluster-network-02-config.yml
│   ├── cluster-proxy-01-config.yaml
│   ├── cluster-scheduler-02-config.yml
│   ├── cvo-overrides.yaml
│   ├── kube-cloud-config.yaml
│   ├── kube-system-configmap-root-ca.yaml
│   ├── machine-config-server-tls-secret.yaml
│   └── openshift-config-secret-pull-secret.yaml
├── openshift
│   ├── 99_cloud-creds-secret.yaml
│   ├── 99_kubeadmin-password-secret.yaml
│   ├── 99_openshift-cluster-api_master-machines-0.yaml
│   ├── 99_openshift-cluster-api_master-machines-1.yaml
│   ├── 99_openshift-cluster-api_master-machines-2.yaml
│   ├── 99_openshift-cluster-api_master-user-data-secret.yaml
│   ├── 99_openshift-cluster-api_worker-machineset-0.yaml
│   ├── 99_openshift-cluster-api_worker-machineset-1.yaml
│   ├── 99_openshift-cluster-api_worker-machineset-2.yaml
│   ├── 99_openshift-cluster-api_worker-user-data-secret.yaml
│   ├── 99_openshift-machineconfig_99-master-ssh.yaml
│   ├── 99_openshift-machineconfig_99-worker-ssh.yaml
│   ├── 99_role-cloud-creds-secret-reader.yaml
│   └── openshift-install-manifests.yaml
└── README.md

3 directories, 36 files


```

**Update the resoure group**

I used predefined resource group, instead of default resource group.

```
[root@localhost aro06]# cat manifests/cluster-infrastructure-02-config.yml
apiVersion: config.openshift.io/v1
kind: Infrastructure
metadata:
  creationTimestamp: null
  name: cluster
spec:
  cloudConfig:
    key: config
    name: cloud-provider-config
  platformSpec:
    type: Azure
status:
  apiServerInternalURI: https://api-int.aro.example.opentlc.com:6443
  apiServerURL: https://api.aro.example.opentlc.com:6443
  controlPlaneTopology: HighlyAvailable
  etcdDiscoveryDomain: ""
  infrastructureName: aro-clmlm
  infrastructureTopology: HighlyAvailable
  platform: Azure
  platformStatus:
    azure:
      cloudName: AzurePublicCloud
      networkResourceGroupName: aro-clmlm-rg
      resourceGroupName: aro-clmlm-rg
    type: Azure
```

> `Auto generated route group name <infrastructureName>-rg : aro-clmlm-rg`

```
[root@localhost aro06]# grep -R aro-clmlm-rg ./manifests/
./manifests/cloud-provider-config.yaml:    \"aro-clmlm-rg\",\n\t\"location\": \"eastus\",\n\t\"vnetName\": \"aro-clmlm-vnet\",\n\t\"vnetResourceGroup\":
./manifests/cloud-provider-config.yaml:    \"aro-clmlm-rg\",\n\t\"subnetName\": \"aro-clmlm-worker-subnet\",\n\t\"securityGroupName\":
./manifests/cluster-dns-02-config.yml:    id: /subscriptions/ede7f891-835c-4128-af5b-0e53848e54e7/resourceGroups/aro-clmlm-rg/providers/Microsoft.Network/privateDnsZones/aro.example.opentlc.com
./manifests/cluster-infrastructure-02-config.yml:      networkResourceGroupName: aro-clmlm-rg
./manifests/cluster-infrastructure-02-config.yml:      resourceGroupName: aro-clmlm-rg

```
>Replace all `aro-clmlm-rg` will `openenv-g96kt` predefined resource group

```
[root@localhost aro06]# vim ./manifests/cluster-infrastructure-02-config.yml
~                                                                                                                                               
~                                                                                                                                               
:%s#aro-clmlm-rg#openenv-g96kt#g

```

```
[root@localhost aro06]# vim ./manifests/cloud-provider-config.yaml
~                                                                                                                                               
~                                                                                                                                               
:%s#aro-clmlm-rg#openenv-g96kt#g

```

Confirmed that there is no more `aro-clmlm-rg` in `./manifests/` dir
```
[root@localhost aro06]# grep -R aro-clmlm-rg ./manifests/
[root@localhost aro06]# 

```


**Delete machines & machineset configuration files for master and worker**

```
[root@localhost aro06]# ls openshift/
99_cloud-creds-secret.yaml                             99_openshift-cluster-api_worker-machineset-1.yaml
99_kubeadmin-password-secret.yaml                      99_openshift-cluster-api_worker-machineset-2.yaml
99_openshift-cluster-api_master-machines-0.yaml        99_openshift-cluster-api_worker-user-data-secret.yaml
99_openshift-cluster-api_master-machines-1.yaml        99_openshift-machineconfig_99-master-ssh.yaml
99_openshift-cluster-api_master-machines-2.yaml        99_openshift-machineconfig_99-worker-ssh.yaml
99_openshift-cluster-api_master-user-data-secret.yaml  99_role-cloud-creds-secret-reader.yaml
99_openshift-cluster-api_worker-machineset-0.yaml      openshift-install-manifests.yaml

[root@localhost aro06]# rm -f ./openshift/99_openshift-cluster-api_master-machines-*.yaml 
[root@localhost aro06]# rm -f ./openshift/99_openshift-cluster-api_worker-machineset-*.yaml

[root@localhost aro06]# ls ./openshift
99_cloud-creds-secret.yaml                             99_openshift-machineconfig_99-master-ssh.yaml
99_kubeadmin-password-secret.yaml                      99_openshift-machineconfig_99-worker-ssh.yaml
99_openshift-cluster-api_master-user-data-secret.yaml  99_role-cloud-creds-secret-reader.yaml
99_openshift-cluster-api_worker-user-data-secret.yaml  openshift-install-manifests.yaml

```

Confirmed that there is no more `aro-clmlm-rg` in `./manifests/` dir
```
[root@localhost aro06]# grep -R aro-clmlm-rg ./openshift/
[root@localhost aro06]# 

```

**Set env variable based on manifest files**
```
[root@localhost aro06]# export INFRA_ID=`yq -r '.status.infrastructureName' manifests/cluster-infrastructure-02-config.yml`
[root@localhost aro06]# echo $INFRA_ID
aro-clmlm

[root@localhost aro06]# export RESOURCE_GROUP=`yq -r '.status.platformStatus.azure.resourceGroupName' manifests/cluster-infrastructure-02-config.yml`
[root@localhost aro06]# echo $RESOURCE_GROUP
openenv-g96kt

```
## 04 Create Ignite files

```
[root@localhost aro06]# ../openshift-install create ignition-configs
INFO Consuming Common Manifests from target directory 
INFO Consuming OpenShift Install (Manifests) from target directory 
INFO Consuming Master Machines from target directory 
INFO Consuming Openshift Manifests from target directory 
INFO Consuming Worker Machines from target directory 
INFO Ignition-Configs created in: . and auth      

[root@localhost aro06]# tree
.
├── auth
│   ├── kubeadmin-password
│   └── kubeconfig
├── bootstrap.ign
├── images
│   ├── azure-dns-zone-01.png
│   ├── azure-dns-zone-02.png
│   ├── azure-dns-zone-03.png
│   ├── azure-dns-zone-04.png
│   ├── azure-portal-01.png
│   ├── azure-rg-01.png
│   └── test
├── master.ign
├── metadata.json
├── README.md
└── worker.ign

2 directories, 14 files

```

**Verify the env varaible**

```
[root@localhost aro06]# echo $CLUSTER_NAME
aro

[root@localhost aro06]# echo $AZURE_REGION
eastus

[root@localhost aro06]# echo $AZURE_REGION
eastus

[root@localhost aro06]# echo $BASE_DOMAIN_RESOURCE_GROUP
openenv-g96kt

[root@localhost aro06]# echo $INFRA_ID
aro-clmlm

[root@localhost aro06]# echo $RESOURCE_GROUP
openenv-g96kt

[root@localhost aro06]# export SSH_KEY=`cat ~/.ssh/id_ed25519.pub`
[root@localhost aro06]# echo $SSH_KEY
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIONeWKSpAxbJrkkThCxUjlVe80jSz2y9hIpDLpx43AyY root@localhost.localdomain

```

## 05 Create an Azure identity for predefined the resource group

**Create an Azure identity for the resource group**
```
[root@localhost aro06]# echo az identity create -g $RESOURCE_GROUP -n ${INFRA_ID}-identity
az identity create -g openenv-g96kt -n aro-clmlm-identity

[root@localhost aro06]# az identity create -g $RESOURCE_GROUP -n ${INFRA_ID}-identity

```

**Grant the Contributor role to the Azure identity**
```
[root@localhost aro06]# export PRINCIPAL_ID=`az identity show -g $RESOURCE_GROUP -n ${INFRA_ID}-identity --query principalId --out tsv`

[root@localhost aro06]# export RESOURCE_GROUP_ID=`az group show -g $RESOURCE_GROUP --query id --out tsv`

[root@localhost aro06]# echo az role assignment create --assignee "$PRINCIPAL_ID" --role 'Contributor' --scope "$RESOURCE_GROUP_ID"
az role assignment create --assignee 3cc79d25-f1d5-482f-828c-092671226a6a --role Contributor --scope /subscriptions/ede7f891-835c-4128-af5b-0e53848e54e7/resourceGroups/openenv-g96kt

[root@localhost aro06]# az role assignment create --assignee "$PRINCIPAL_ID" --role 'Contributor' --scope "$RESOURCE_GROUP_ID"

```

**Newly ceated Azure identity on Azure portal**
![Once Login Azure portal](images/azure-rg-identity-01.png)

## 06 Uploading the RHCOS cluster image and bootstrap Ignition config file

**Create an Azure storage account to store the VHD cluster image**

```
[root@localhost aro06]# az storage account create -g $RESOURCE_GROUP --location $AZURE_REGION --name ${CLUSTER_NAME}sa --kind Storage --sku Standard_LRS
```

**Export the storage account key as an environment variable**

```
[root@localhost aro06]# export ACCOUNT_KEY=`az storage account keys list -g $RESOURCE_GROUP --account-name ${CLUSTER_NAME}sa --query "[0].value" -o tsv`

```

**Export the URL of the RHCOS VHD to an environment variable**

```
[root@localhost aro06]# export VHD_URL=$(../openshift-install coreos print-stream-json | jq -r '.architectures.x86_64."rhel-coreos-extensions"."azure-disk".url')
[root@localhost aro06]# echo $VHD_URL
https://rhcos.blob.core.windows.net/imagebucket/rhcos-410.84.202201251210-0-azure.x86_64.vhd

```

**Create the storage container for the VHD**

```
[root@localhost aro06]# az storage container create --name vhd --account-name ${CLUSTER_NAME}sa --account-key $ACCOUNT_KEY

```

**Copy the local VHD to a blob**

```
[root@localhost aro06]# az storage blob copy start --account-name ${CLUSTER_NAME}sa --account-key $ACCOUNT_KEY --destination-blob "rhcos.vhd" --destination-container vhd --source-uri "$VHD_URL"

```

**Track copy progressgin..**
Take a few mins
```
status="unknown"
while [ "$status" != "success" ]
do
  status=`az storage blob show --container-name vhd --name "rhcos.vhd" --account-name ${CLUSTER_NAME}sa --account-key $ACCOUNT_KEY -o tsv --query properties.copy.status`
  echo $status
done


pending
pending
pending
success

```
**New Strorage Account on Azure portal**
![Once Login Azure portal](images/azure-storage-container-01.png)


**New vhd container on Azure portal**
![Once Login Azure portal](images/azure-storage-container-02.png)


**Create a blob storage container and upload the generated bootstrap.ign file**

```
[root@localhost aro06]# az storage container create --name files --account-name ${CLUSTER_NAME}sa --account-key ${ACCOUNT_KEY}

[root@localhost aro06]# az storage blob upload --account-name ${CLUSTER_NAME}sa --account-key $ACCOUNT_KEY -c "files" -f "bootstrap.ign" -n "bootstrap.ign"
```


## 07 creating private DNS zones


**Create the private DNS zone**

```
[root@localhost aro06]# az network private-dns zone create -g $RESOURCE_GROUP -n ${CLUSTER_NAME}.${BASE_DOMAIN}

```


**New Privare DNS Zone on Azure portal**
![Once Login Azure portal](images/azure-private-dns-zone-01.png)


## 08 Prepare the ARM templates



```
[root@localhost aro06]# ls -l 0*.json
-rw-r--r--. 1 root root 2849 Apr  9 19:33 01_vnet.json
-rw-r--r--. 1 root root 1168 Apr  9 19:33 02_storage.json
-rw-r--r--. 1 root root 8332 Apr  9 19:33 03_infra.json
-rw-r--r--. 1 root root 6189 Apr  9 19:33 04_bootstrap.json
-rw-r--r--. 1 root root 5760 Apr  9 19:33 05_masters.json
-rw-r--r--. 1 root root 5589 Apr  9 19:33 06_workers.json

```


Please refer to the below link for all templates:
[OpenShift Pages](https://docs.openshift.com/container-platform/4.10/installing/installing_azure/installing-azure-user-infra.html)


## 09 Creating a VNet in Azure

**Create the deployment by using the az CLI**

```
[root@localhost aro06]# az deployment group create -g ${RESOURCE_GROUP} --template-file "01_vnet.json" --parameters baseName="${INFRA_ID}"

```

**Link the VNet template to the private DNS zone**

```
[root@localhost aro06]# az network private-dns link vnet create -g ${RESOURCE_GROUP} -z ${CLUSTER_NAME}.${BASE_DOMAIN} -n ${INFRA_ID}-network-link -v "${INFRA_ID}-vnet" -e false
```



**New VNet & Networ Security Group on Azure portal**
![Once Login Azure portal](images/azure-vnet-nsg-01.png)



## 10 Deploying the RHCOS cluster image for the Azure infrastructure

**Export the RHCOS VHD blob URL as a variable**

```
[root@localhost aro06]# export VHD_BLOB_URL=`az storage blob url --account-name ${CLUSTER_NAME}sa --account-key ${ACCOUNT_KEY} -c vhd -n "rhcos.vhd" -o tsv`

```


**Deploy the cluster image**

```
[root@localhost aro06]# az deployment group create -g openenv-g96kt --template-file 02_storage.json --parameters vhdBlobURL="${VHD_BLOB_URL}" --parameters baseName="${INFRA_ID}"

```
>The blob URL of the RHCOS VHD to be used to create master and worker machines.

**New Image Azure portal**
![Once Login Azure portal](images/azure-image-01.png)


## 11 Creating networking and load balancing components in Azure

**Create the deployment by using the az CLI**

```
[root@localhost aro06]# az deployment group create -g ${RESOURCE_GROUP} --template-file "03_infra.json" --parameters privateDNSZoneName="${CLUSTER_NAME}.${BASE_DOMAIN}" --parameters baseName="${INFRA_ID}"

```

**Create an api DNS record in the public zone for the API public load balancer. The ${BASE_DOMAIN_RESOURCE_GROUP} variable must point to the resource group where the public DNS zone exists**


Export the following variable

```
[root@localhost aro06]# export PUBLIC_IP=`az network public-ip list -g ${RESOURCE_GROUP} --query "[?name=='${INFRA_ID}-master-pip'] | [0].ipAddress" -o tsv`
[root@localhost aro06]# echo $PUBLIC_IP
52.191.100.197

```

Create the api DNS record in a existing public zone

```
[root@localhost aro06]# az network dns record-set a add-record -g ${BASE_DOMAIN_RESOURCE_GROUP} -z ${BASE_DOMAIN} -n api.${CLUSTER_NAME} -a ${PUBLIC_IP} --ttl 60

```


**New LBs & Public IP Azure portal**
![Once Login Azure portal](images/azure-LBs-PubIP-01.png)




